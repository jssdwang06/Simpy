# Festo分配站仿真程序架构总览

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (GUI Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  主窗口           │  控制面板         │  性能指标面板        │
│  (Matplotlib)     │  (ControlPanel)   │  (PerformancePanel) │
│  - 状态图表       │  - 控制按钮       │  - 实时KPI显示      │
│  - 传感器图表     │  - 状态指示器     │  - 数据导出         │
│  - 执行器图表     │  - 补料控制       │  - 指标重置         │
├─────────────────────────────────────────────────────────────┤
│                   业务逻辑层 (Business Layer)                │
├─────────────────────────────────────────────────────────────┤
│                    FestoStation (核心类)                    │
│  ┌─────────────────┬─────────────────┬─────────────────────┐ │
│  │   状态机管理    │   性能指标计算   │    逻辑表达式      │ │
│  │  - 6状态循环    │  - 吞吐量计算    │  - 传感器逻辑      │ │
│  │  - 状态转换     │  - 利用率分析    │  - 执行器控制      │ │
│  │  - 时间管理     │  - 瓶颈识别      │  - 安全联锁        │ │
│  └─────────────────┴─────────────────┴─────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   仿真引擎层 (Simulation Layer)              │
├─────────────────────────────────────────────────────────────┤
│                      SimPy 实时环境                         │
│  - 离散事件仿真    - 实时时钟同步    - 进程管理             │
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  历史数据存储      │  性能指标数据    │  配置参数           │
│  - 时间序列        │  - 循环时间      │  - 时间参数         │
│  - 状态历史        │  - 停机时间      │  - 容量参数         │
│  - 传感器历史      │  - 状态持续时间  │  - 界面参数         │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 核心工作流程

### 1. 状态机循环 (6状态)
```
State 0 (空闲) → State 1 (气缸伸出) → State 2 (移动到料仓) 
     ↑                                           ↓
State 6 (真空关闭) ← State 5 (返回下游站) ← State 4 (气缸缩回)
     ↑                                           ↓
     └─────────── State 3 (真空开启) ←──────────┘
```

### 2. 数据流向
```
用户操作 → 控制面板 → FestoStation → SimPy环境 → 状态更新
    ↓                                              ↓
性能面板 ← 性能计算 ← 数据收集 ← 仿真执行 ← 界面刷新
```

## 📊 关键性能指标 (KPI)

### 生产效率指标
- **吞吐量**: `(总工件数 / 总时间) × 3600` pieces/hour
- **设备利用率**: `(有效工作时间 / 总时间) × 100%`
- **平均循环时间**: `总循环时间 / 循环次数`

### 瓶颈分析指标
- **状态持续时间分析**: 识别最耗时的工作状态
- **停机时间分析**: 补料等待时间统计
- **补料频率分析**: 补料操作的频次和效率

## 🎛️ 用户界面组件

### 控制面板布局
```
┌─────────────────────────────────────────┐
│                Control                  │
├─────────────────────────────────────────┤
│  [Start]        [Emergency Stop]        │
│  [Performance Metrics]    [Exit]        │
├─────────────────────────────────────────┤
│            Workpiece Control            │
│  Refill Amount: [1-8] [Manual Refill]   │
├─────────────────────────────────────────┤
│                Status                   │
│  Workpieces: [8]    State: [0]          │
│  Sensors: S1 S2 S3 S4 S5 S6 k P         │
│  Actuators: Y1 Y2 Y3                    │
└─────────────────────────────────────────┘
```

### 性能指标面板
```
┌─────────────────────────────────────────┐
│           Performance Metrics           │
├─────────────────────────────────────────┤
│  Production Metrics                     │
│  - Total Workpieces: 15                 │
│  - Throughput: 219.6 pieces/hour        │
├─────────────────────────────────────────┤
│  Time Analysis                          │
│  - Simulation Time: 245.7 s             │
│  - Utilization: 87.3%                   │
├─────────────────────────────────────────┤
│  [Export Report] [Reset Metrics]        │
└─────────────────────────────────────────┘
```

## 🔧 技术实现要点

### 多线程架构
- **主线程**: GUI界面和用户交互
- **仿真线程**: SimPy环境运行 (daemon线程)
- **更新线程**: 定时刷新界面数据

### 状态同步机制
- **事件驱动**: SimPy事件机制处理状态转换
- **定时更新**: Tkinter.after()方法实现界面刷新
- **数据一致性**: Python GIL保证线程安全

### 性能优化策略
- **增量计算**: 避免重复计算性能指标
- **内存管理**: 合理控制历史数据大小
- **响应式更新**: 按需刷新减少不必要的重绘

## 📁 文件结构

```
festo.py                    # 主程序 (900行)
├── FestoStation           # 核心业务逻辑类
├── ControlPanel           # 用户控制界面类  
├── PerformancePanel       # 性能指标界面类
└── run_gui()              # 主程序入口函数

performance_demo.py         # 功能演示程序
test_exit_button.py        # 按钮测试程序
ARCHITECTURE_DOCUMENTATION.md  # 详细架构文档
PERFORMANCE_METRICS_README.md  # 性能指标说明
sample_performance_report.json # 示例性能报告
```

## 🚀 快速开始

```bash
# 1. 安装依赖
pip install simpy matplotlib

# 2. 运行程序
python festo.py

# 3. 基本操作
- 点击 "Start" 开始仿真
- 观察状态图表和传感器变化
- 点击 "Performance Metrics" 查看实时KPI
- 料仓空时使用 "Manual Refill" 补料
- 导出性能报告进行分析
```

## 🔮 扩展可能性

### 功能扩展
- **新增传感器/执行器**: 扩展I/O点数
- **复杂工艺流程**: 增加更多工作状态
- **多站点仿真**: 连接多个工作站
- **网络通信**: 支持远程监控

### 性能增强
- **数据库集成**: 持久化存储历史数据
- **Web界面**: 基于浏览器的监控界面
- **报警系统**: 异常情况自动通知
- **预测分析**: 基于历史数据的趋势预测

---

**架构设计**: 模块化、可扩展、高性能  
**技术特点**: 实时仿真、多线程、图形化界面  
**应用价值**: 工业4.0、智能制造、性能优化
