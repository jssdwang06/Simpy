# Festo工作站模拟器详细设计框图

## 1. 核心类: FestoStation

### 1.1 初始化参数与状态变量
```
+-------------------------------------------------------+
|                 FestoStation.__init__                 |
+-------------------------------------------------------+
| 输入参数:                                             |
| - env: SimPy实时环境实例                              |
+-------------------------------------------------------+
| 时间参数:                                             |
| - extend_time = 2: 气缸伸缩时间(秒)                   |
| - move_time = 3: 操作器移动时间(秒)                   |
| - vacuum_time = 2: 真空吸盘动作时间(秒)               |
+-------------------------------------------------------+
| 工件和杂志状态:                                       |
| - workpiece_count = 8: 初始工件数量                   |
| - S3 = True: 杂志非空标志(True=非空)                  |
| - k = False: 需要补充标志(由!S3计算得出)              |
+-------------------------------------------------------+
| 位置传感器初始状态:                                   |
| - S1 = True: 气缸收回位置传感器(True=收回)            |
| - S2 = False: 气缸伸出位置传感器(True=伸出)           |
| - S4 = True: 操作器在下一工位传感器(True=在位)        |
| - S5 = False: 操作器在杂志处传感器(True=在位)         |
| - S6 = False: 真空吸盘状态传感器(True=吸附)           |
+-------------------------------------------------------+
| 执行器初始状态:                                       |
| - Y1 = False: 气缸控制(True=伸出,False=收回)          |
| - Y2 = False: 操作器控制(True=移动,False=停止)        |
| - Y3 = False: 真空吸盘控制(True=开启,False=关闭)      |
+-------------------------------------------------------+
| 状态机和控制事件:                                     |
| - state = 0: 初始状态(0-8)                            |
| - emergency_flag = False: 紧急停止标志                |
| - start_event = env.event(): 启动事件                 |
+-------------------------------------------------------+
| 时间测量变量:                                         |
| - cycle_start_time = 0: 循环开始时间                  |
| - t1 = 0: 循环时间(完整正常循环)                      |
| - t2 = 0: 杂志补充时间                                |
| - magazine_refill_time = 10: 杂志补充等待时间(秒)     |
| - t2_start_marker = 0: t2测量开始标记                 |
| - first_cycle = True: 首次循环标志                    |
| - cycle_blocked = False: 循环阻塞标志                 |
| - measuring_t2 = False: t2测量中标志                  |
+-------------------------------------------------------+
| 历史记录数组(用于绘图):                               |
| - time_history = []: 时间点历史                       |
| - state_history = []: 状态历史                        |
| - workpiece_history = []: 工件计数历史                |
| - sensor_history = {}: 传感器状态历史字典             |
|   - 'S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'k'           |
| - act_history = {}: 执行器状态历史字典                |
|   - 'Y1', 'Y2', 'Y3'                                  |
| - t1_history = []: t1时间测量历史                     |
| - t2_history = []: t2时间测量历史                     |
+-------------------------------------------------------+
| 初始化操作:                                           |
| - 启动状态机进程: env.process(self.run())             |
+-------------------------------------------------------+
```

### 1.2 核心方法

```
+-------------------------------------------------------+
|               FestoStation.update_logic               |
+-------------------------------------------------------+
| 功能: 根据当前传感器状态更新执行器逻辑表达式          |
| 输入: 无(使用类内部状态)                              |
| 输出: 无(更新类内部执行器状态)                        |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 1. 更新k = !S3 (杂志空标志)                           |
| 2. 根据t1和t2的关系确定Y1的逻辑:                      |
|    - 首次循环或t2未测量: Y1 = !S6                     |
|    - t1 > t2: Y1 = !S6 (正常操作)                     |
|    - t2 > t1: Y1 = !S6 && (!k || !S4) (阻塞操作)      |
| 3. 更新Y2 = S2 || (!S1 && !S4)                        |
| 4. 更新Y3 = S5 || (S1 && !S4)                         |
+-------------------------------------------------------+

+-------------------------------------------------------+
|                  FestoStation.log                     |
+-------------------------------------------------------+
| 功能: 记录当前状态到历史数组并输出信息                |
| 输入: msg - 要输出的消息字符串                        |
| 输出: 无(更新历史数组并打印到控制台)                  |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 1. 获取当前时间t = env.now                            |
| 2. 将当前时间和状态添加到历史数组                     |
| 3. 将所有传感器和执行器状态添加到对应历史字典         |
| 4. 将t1和t2添加到对应历史数组                         |
| 5. 格式化输出时间、工件数、t1、t2和消息               |
+-------------------------------------------------------+

+-------------------------------------------------------+
|              FestoStation.trigger_start               |
+-------------------------------------------------------+
| 功能: 触发系统启动                                    |
| 输入: 无                                              |
| 输出: 无(触发start_event事件)                         |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 1. 检查当前是否在状态0(空闲)                          |
| 2. 如果是，尝试触发start_event.succeed()              |
| 3. 如果已经启动过，捕获RuntimeError并忽略             |
| 4. 如果不在状态0，输出启动被忽略的消息                |
+-------------------------------------------------------+

+-------------------------------------------------------+
|           FestoStation.trigger_emergency              |
+-------------------------------------------------------+
| 功能: 触发紧急停止                                    |
| 输入: 无                                              |
| 输出: 无(中断状态机进程)                              |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 1. 检查当前是否不在状态0且emergency_flag为False       |
| 2. 如果条件满足，设置emergency_flag为True             |
| 3. 调用process.interrupt()中断状态机进程              |
+-------------------------------------------------------+

+-------------------------------------------------------+
|              FestoStation.trigger_exit                |
+-------------------------------------------------------+
| 功能: 触发程序退出                                    |
| 输入: 无                                              |
| 输出: 无(关闭图表并退出程序)                          |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 1. 输出退出消息                                       |
| 2. 关闭所有matplotlib图表(plt.close('all'))           |
| 3. 调用sys.exit()退出程序                             |
+-------------------------------------------------------+
```

### 1.3 状态机主循环

```
+-------------------------------------------------------+
|                  FestoStation.run                     |
+-------------------------------------------------------+
| 功能: 实现状态机主循环逻辑                            |
| 输入: 无                                              |
| 输出: SimPy生成器函数                                 |
+-------------------------------------------------------+
| 状态机实现:                                           |
|                                                       |
| 状态0: 空闲状态                                       |
| - 设置初始传感器状态: S1=True, S3=True, S4=True       |
| - 更新执行器逻辑                                      |
| - 等待start_event事件                                 |
|                                                       |
| 循环开始: 记录cycle_start_time = env.now              |
|                                                       |
| 状态1: 气缸伸出                                       |
| - 更新执行器逻辑                                      |
| - 等待extend_time秒                                   |
| - 更新传感器: S2=True, S1=False                       |
|                                                       |
| 状态2: 操作器移动到杂志                               |
| - 更新执行器逻辑                                      |
| - 等待move_time秒                                     |
| - 更新传感器: S5=True, S4=False                       |
|                                                       |
| 状态3: 真空吸盘开启                                   |
| - 更新执行器逻辑                                      |
| - 等待vacuum_time秒                                   |
| - 更新传感器: S6=True                                 |
|                                                       |
| 状态4: 气缸收回                                       |
| - 更新执行器逻辑                                      |
| - 等待extend_time秒                                   |
| - 更新传感器: S1=True, S2=False                       |
| - 减少工件计数: workpiece_count -= 1                  |
| - 更新S3 = (workpiece_count > 0)                      |
|                                                       |
| 杂志空检查分支:                                       |
| 如果S3=False(杂志空):                                 |
|   - 记录t2_start_marker = env.now                     |
|   - 设置measuring_t2 = True                           |
|   - 计算t1 = env.now - cycle_start_time              |
|   - 进入状态7: 杂志空，等待补充                       |
|   - 等待直到S3变为True(杂志被补充)                    |
|   - 重置工件计数: workpiece_count = 8                 |
|   - 更新传感器: S3=True, S6=False                     |
|   - 进入状态8: 已补充，等待3秒                        |
|   - 等待3秒                                           |
|   - 返回状态1                                         |
|   - 如果measuring_t2=True:                            |
|     - 计算t2 = env.now - t2_start_marker              |
|     - 设置measuring_t2 = False                        |
|     - 比较t1和t2，设置cycle_blocked标志               |
|   - 设置first_cycle = False                           |
|   - 继续下一循环                                      |
|                                                       |
| 状态5: 操作器返回下一工位                             |
| - 更新执行器逻辑                                      |
| - 等待move_time秒                                     |
| - 更新传感器: S4=True, S5=False                       |
|                                                       |
| 状态6: 真空吸盘关闭                                   |
| - 更新执行器逻辑                                      |
| - 等待vacuum_time秒                                   |
| - 更新传感器: S6=False                                |
| - 计算完整循环时间: t1 = env.now - cycle_start_time   |
| - 设置first_cycle = False                             |
|                                                       |
| 返回状态1，开始新循环                                 |
+-------------------------------------------------------+
| 异常处理:                                             |
| 捕获simpy.Interrupt异常(紧急停止):                    |
| - 重置到状态0                                         |
| - 重置所有传感器状态                                  |
| - 更新执行器逻辑                                      |
| - 重置emergency_flag = False                          |
| - 重置start_event = env.event()                       |
| - 递归调用run()重新开始状态机                         |
+-------------------------------------------------------+
```

## 2. 辅助函数: blank_generator

```
+-------------------------------------------------------+
|                   blank_generator                     |
+-------------------------------------------------------+
| 功能: 实现杂志补充逻辑                                |
| 输入:                                                 |
| - env: SimPy环境实例                                  |
| - station: FestoStation实例                           |
| 输出: SimPy生成器函数                                 |
+-------------------------------------------------------+
| 实现逻辑:                                             |
| 无限循环:                                             |
|   如果station.S3为False(杂志空):                      |
|     - 等待station.magazine_refill_time秒              |
|     - 设置station.S3 = True(杂志已补充)               |
|     - 记录补充完成日志                                |
|   否则:                                               |
|     - 等待1秒(轮询检查)                               |
+-------------------------------------------------------+
```

## 3. 主函数: run_gui

```
+-------------------------------------------------------+
|                      run_gui                          |
+-------------------------------------------------------+
| 功能: 设置模拟环境和GUI界面                           |
| 输入: 无                                              |
| 输出: 无(启动GUI主循环)                               |
+-------------------------------------------------------+
| 实现步骤:                                             |
|                                                       |
| 1. SimPy环境设置:                                     |
| - 创建RealtimeEnvironment(factor=1.0, strict=True)    |
| - 创建FestoStation实例                                |
| - 启动blank_generator进程                             |
| - 在单独线程中运行env.run()                           |
|                                                       |
| 2. Tkinter GUI设置:                                   |
| - 创建主窗口root = tk.Tk()                            |
| - 设置窗口标题和关闭处理                              |
|                                                       |
| 3. Matplotlib图表设置:                                |
| - 创建8个子图(fig, axs = plt.subplots(8,1))           |
| - 创建FigureCanvasTkAgg嵌入Tkinter                    |
|                                                       |
| 4. 定义动画更新函数update(frame):                     |
|   a. 状态转换图(axs[0]):                              |
|      - 绘制状态历史阶梯图                             |
|      - 标注当前状态                                   |
|                                                       |
|   b. 工件计数图(axs[1]):                              |
|      - 绘制工件数量历史阶梯图                         |
|      - 标注当前工件数                                 |
|                                                       |
|   c. t1和t2时间图(axs[2]):                            |
|      - 绘制t1和t2历史折线图                           |
|      - 标注当前t1和t2值                               |
|                                                       |
|   d. 传感器状态图(axs[3-5]):                          |
|      - S1和S2气缸状态图                               |
|      - S4和S5操作器位置图                             |
|      - S6真空吸盘状态图                               |
|                                                       |
|   e. 杂志状态图(axs[6]):                              |
|      - S3和k状态图                                    |
|                                                       |
|   f. 执行器状态图(axs[7]):                            |
|      - Y1, Y2, Y3状态图                               |
|                                                       |
| 5. 创建动画:                                          |
| - ani = FuncAnimation(fig, update, interval=500)      |
|                                                       |
| 6. 创建控制按钮:                                      |
| - 启动按钮: 调用station.trigger_start()               |
| - 紧急停止按钮: 调用station.trigger_emergency()       |
| - 退出按钮: 调用station.trigger_exit()                |
|                                                       |
| 7. 启动Tkinter主循环:                                 |
| - root.mainloop()                                     |
+-------------------------------------------------------+
```

## 4. 数据流图

```
+----------------+    +----------------+    +----------------+
|  传感器状态    |    |  状态机逻辑    |    |  执行器控制    |
|  S1-S6, k      |--->|  状态0-8       |--->|  Y1-Y3         |
+----------------+    +----------------+    +----------------+
        ^                     |                     |
        |                     v                     v
+----------------+    +----------------+    +----------------+
|  工件计数      |<---|  时间测量      |    |  历史记录      |
|  workpiece_count|    |  t1, t2        |    |  各种history  |
+----------------+    +----------------+    +----------------+
        ^                     ^                     |
        |                     |                     v
+----------------+    +----------------+    +----------------+
|  杂志补充      |    |  GUI控制按钮   |    |  可视化图表    |
|  blank_generator|<---|  Start/Stop/Exit|<---|  8个子图      |
+----------------+    +----------------+    +----------------+
```

## 5. 关键逻辑表达式详解

```
1. 杂志空标志: k = !S3

2. 气缸控制逻辑(Y1):
   - 首次循环或t2未测量: Y1 = !S6
   - 当t1 > t2时(正常操作): Y1 = !S6
   - 当t2 > t1时(阻塞操作): Y1 = !S6 && (!k || !S4)
   
   解释:
   - !S6: 只有当真空吸盘未启动时才能操作气缸
   - 当t2 > t1时，增加额外条件(!k || !S4):
     * !k: 杂志非空时可以操作
     * !S4: 操作器不在下一工位时可以操作
     * 这确保了当杂志补充时间长于循环时间时，系统不会在杂志为空且操作器在下一工位时尝试启动新循环

3. 操作器控制逻辑(Y2): Y2 = S2 || (!S1 && !S4)
   解释:
   - S2: 当气缸伸出时移动操作器
   - !S1 && !S4: 当气缸不在收回位置且操作器不在下一工位时移动操作器

4. 真空吸盘控制逻辑(Y3): Y3 = S5 || (S1 && !S4)
   解释:
   - S5: 当操作器在杂志处时启动真空吸盘
   - S1 && !S4: 当气缸收回且操作器不在下一工位时启动真空吸盘
```

## 6. 时间测量逻辑详解

```
t1测量(循环时间):
- 开始: 在每个循环开始时记录cycle_start_time = env.now
- 结束: 
  * 如果杂志为空: 在状态4结束时计算t1 = env.now - cycle_start_time
  * 正常循环: 在状态6结束时计算t1 = env.now - cycle_start_time

t2测量(杂志补充时间):
- 开始: 当杂志变为空时记录t2_start_marker = env.now
- 结束: 当杂志补充完成并返回状态1时计算t2 = env.now - t2_start_marker

t1和t2比较逻辑:
- 如果t1 > t2: 系统可以正常循环，因为杂志补充速度快于工作循环
- 如果t2 > t1: 系统需要等待杂志补充，使用更复杂的Y1逻辑防止在杂志为空时启动新循环
```

## 7. 状态机详细流程图

```
+-------------------+
|    状态0: 空闲    |
+-------------------+
         |
         | [启动按钮]
         v
+-------------------+
|  状态1: 气缸伸出  |<---------+
+-------------------+          |
         |                     |
         | [extend_time]       |
         v                     |
+-------------------+          |
|状态2: 移动到杂志  |          |
+-------------------+          |
         |                     |
         | [move_time]         |
         v                     |
+-------------------+          |
|状态3: 真空吸盘开启|          |
+-------------------+          |
         |                     |
         | [vacuum_time]       |
         v                     |
+-------------------+          |
|  状态4: 气缸收回  |          |
+-------------------+          |
         |                     |
    +----+----+                |
    |         |                |
[S3=True] [S3=False]           |
    |         |                |
    |         v                |
    |  +-------------------+   |
    |  |状态7: 杂志空等待 |   |
    |  +-------------------+   |
    |         |                |
    |         | [杂志补充]     |
    |         v                |
    |  +-------------------+   |
    |  |状态8: 已补充等待 |   |
    |  +-------------------+   |
    |         |                |
    |         | [3秒等待]      |
    |         +----------------+
    v
+-------------------+
|状态5: 返回下一站 |
+-------------------+
         |
         | [move_time]
         v
+-------------------+
|状态6: 真空吸盘关闭|
+-------------------+
         |
         | [vacuum_time]
         +----------------+
```

## 8. 关键时序图

### 8.1 正常循环时序(t1 > t2)

```
时间轴 ─────────────────────────────────────────────────────────>
状态   0    1    2    3    4    5    6    1    2    3    4    ...
      │    │    │    │    │    │    │    │    │    │    │
S1    │████│    │    │    │████│████│████│    │    │    │████...
S2    │    │████│████│████│    │    │    │████│████│████│    ...
S3    │████│████│████│████│████│████│████│████│████│████│████...
S4    │████│████│    │    │    │████│████│████│    │    │    ...
S5    │    │    │████│████│████│    │    │    │████│████│████...
S6    │    │    │    │████│████│████│    │    │    │████│████...
Y1    │    │████│    │    │    │    │    │████│    │    │    ...
Y2    │    │    │████│    │    │████│    │    │████│    │    ...
Y3    │    │    │    │████│████│    │    │    │    │████│████...
      │    │<──────── t1 ────────>│    │
```

### 8.2 杂志补充时序(t2 > t1)

```
时间轴 ─────────────────────────────────────────────────────────>
状态   0    1    2    3    4    7    8    1    2    3    4    ...
      │    │    │    │    │    │    │    │    │    │    │
S1    │████│    │    │    │████│████│████│    │    │    │████...
S2    │    │████│████│████│    │    │    │████│████│████│    ...
S3    │████│████│████│████│    │████│████│████│████│████│    ...
S4    │████│████│    │    │    │    │    │████│    │    │    ...
S5    │    │    │████│████│████│████│    │    │████│████│████...
S6    │    │    │    │████│████│    │    │    │    │████│████...
Y1    │    │████│    │    │    │    │    │████│    │    │    ...
Y2    │    │    │████│    │    │    │    │    │████│    │    ...
Y3    │    │    │    │████│████│    │    │    │    │████│████...
      │    │<── t1 ──>│    │    │    │    │
      │    │<────────── t2 ────────────>│    │
```

## 9. 系统架构图

```
+-----------------------------------------------------+
|                    GUI层                            |
| +------------------+  +-------------------------+   |
| |   控制按钮面板   |  |      可视化图表面板     |   |
| | - 启动           |  | - 状态转换图            |   |
| | - 紧急停止       |  | - 工件计数图            |   |
| | - 退出           |  | - 时间测量图            |   |
| +------------------+  | - 传感器状态图          |   |
|                       | - 执行器状态图          |   |
|                       +-------------------------+   |
+-----------------------------------------------------+
                          ^
                          |
                          v
+-----------------------------------------------------+
|                    逻辑层                           |
| +------------------+  +-------------------------+   |
| |    状态机控制    |  |       时间测量逻辑      |   |
| | - 状态转换       |  | - t1测量(循环时间)      |   |
| | - 传感器更新     |  | - t2测量(补充时间)      |   |
| | - 执行器控制     |  | - 逻辑表达式调整        |   |
| +------------------+  +-------------------------+   |
+-----------------------------------------------------+
                          ^
                          |
                          v
+-----------------------------------------------------+
|                    模拟层                           |
| +------------------+  +-------------------------+   |
| |  SimPy实时环境   |  |     杂志补充进程        |   |
| | - 时间推进       |  | - 监控杂志状态          |   |
| | - 事件处理       |  | - 定时补充              |   |
| | - 进程调度       |  | - 更新系统状态          |   |
| +------------------+  +-------------------------+   |
+-----------------------------------------------------+
```

## 10. 系统配置参数表

| 参数名称              | 默认值 | 单位 | 说明                           |
|-----------------------|--------|------|--------------------------------|
| extend_time           | 2      | 秒   | 气缸伸缩时间                   |
| move_time             | 3      | 秒   | 操作器移动时间                 |
| vacuum_time           | 2      | 秒   | 真空吸盘动作时间               |
| workpiece_count       | 8      | 个   | 初始工件数量                   |
| magazine_refill_time  | 10     | 秒   | 杂志补充等待时间               |
| animation_interval    | 500    | 毫秒 | 图表刷新间隔                   |
| simulation_factor     | 1.0    | 倍率 | 模拟时间与实际时间比例         |

## 11. 系统状态表

| 状态编号 | 状态名称           | 传感器状态                      | 执行器状态                      |
|----------|--------------------|---------------------------------|---------------------------------|
| 0        | 空闲               | S1=T, S3=T, S4=T                | Y1=F, Y2=F, Y3=F                |
| 1        | 气缸伸出           | S1=F, S2=T                      | Y1=T, Y2=F, Y3=F                |
| 2        | 移动到杂志         | S4=F, S5=T                      | Y1=F, Y2=T, Y3=F                |
| 3        | 真空吸盘开启       | S6=T                            | Y1=F, Y2=F, Y3=T                |
| 4        | 气缸收回           | S1=T, S2=F                      | Y1=F, Y2=F, Y3=T                |
| 5        | 返回下一站         | S4=T, S5=F                      | Y1=F, Y2=T, Y3=T                |
| 6        | 真空吸盘关闭       | S6=F                            | Y1=F, Y2=F, Y3=F                |
| 7        | 杂志空等待         | S1=T, S3=F, S6=F                | Y1=F, Y2=F, Y3=F                |
| 8        | 已补充等待         | S1=T, S3=T, S6=F                | Y1=F, Y2=F, Y3=F                |
